---
- name: Deploy Intranet Portal + Kerberos SSO (nhan.local) ‚Äì Version Ho√†n Ch·ªânh
  hosts: webserver
  become: yes
  vars:
    keytab_path: /etc/apache2/webserver.keytab
    smb_server_ip: 192.168.60.101
    domain_realm: NHAN.LOCAL

  tasks:
    - name: C√†i ƒë·∫∑t packages c·∫ßn thi·∫øt
      apt:
        name:
          - libapache2-mod-auth-gssapi
          - krb5-user
          - sssd
          - sssd-tools
          - realmd
          - adcli
        state: present
        update_cache: yes

    - name: Copy keytab t·ª´ GitHub (files/webserver.keytab)
      copy:
        src: files/webserver.keytab
        dest: "{{ keytab_path }}"
        owner: root
        group: root
        mode: '0600'  # Ch·ªâ root ƒë·ªçc ƒë∆∞·ª£c
      notify: restart apache2

    - name: ƒê·∫£m b·∫£o th∆∞ m·ª•c intranet t·ªìn t·∫°i
      file:
        path: /var/www/intranet
        state: directory
        owner: www-data
        group: www-data
        mode: '0755'

- name: Deploy index.php (Version UX: Copy to Clipboard)
      copy:
        content: |
          <?php
          $raw = $_SERVER['REMOTE_USER'] ?? 'Kh√°ch';
          $user = "Kh√°ch";
          if (strpos($raw, '@') !== false) {
              $user = strtolower(explode('@', $raw)[0]);
          } elseif (strpos($raw, '\\') !== false) {
              $user = strtolower(explode('\\', $raw)[1]);
          } else {
              $user = strtolower($raw);
          }
          $display_name = ucfirst($user);
          $smb_ip = '192.168.60.101'; // IP File Server c·ªßa b·∫°n
          ?>
          <!DOCTYPE html>
          <html lang="vi">
          <head>
              <meta charset="UTF-8">
              <title>Intranet - NHAN CORPORATION</title>
              <style>
                  body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; display: flex; justify-content: center; min-height: 100vh; margin: 0; }
                  .card { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 100%; max-width: 500px; margin-top: 50px; text-align: center; height: fit-content; }
                  h1 { color: #1a73e8; margin-bottom: 10px; }
                  .user-badge { background: #e8f0fe; color: #1a73e8; padding: 5px 15px; border-radius: 20px; font-weight: bold; display: inline-block; margin-bottom: 30px; }
                  .folder-list { list-style: none; padding: 0; }
                  .folder-item { background: #fff; border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
                  .folder-item:hover { border-color: #1a73e8; background: #f8f9fa; }
                  .folder-name { font-weight: 600; color: #333; display: flex; align-items: center; gap: 10px; }
                  .btn-copy { background: #1a73e8; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9em; transition: 0.2s; }
                  .btn-copy:hover { background: #1557b0; }
                  .btn-copy:active { transform: scale(0.98); }
                  .toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 4px; padding: 16px; position: fixed; z-index: 1; bottom: 30px; left: 50%; transform: translateX(-50%); font-size: 17px; }
                  .toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
                  @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
                  @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
              </style>
              <script>
                  function copyPath(path) {
                      navigator.clipboard.writeText(path).then(function() {
                          var x = document.getElementById("toast");
                          x.className = "toast show";
                          x.innerText = "ƒê√£ copy ƒë∆∞·ªùng d·∫´n: " + path;
                          setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
                      }, function(err) {
                          alert('L·ªói copy: ' + err);
                      });
                  }
              </script>
          </head>
          <body>
          <div class="card">
              <h1>NHAN CORPORATION</h1>
              <div class="user-badge">üë§ <?= htmlspecialchars($display_name) ?></div>

              <h3>üìÇ Kho d·ªØ li·ªáu ƒë∆∞·ª£c ph√©p truy c·∫≠p</h3>
              <ul class="folder-list">
          <?php
          $folders = ['Public'];
          // Logic check group (gi·ªØ nguy√™n logic c≈© c·ªßa b·∫°n)
          if ($user === 'nhan') $folders[] = 'IT';
          elseif ($user === 'hai') $folders[] = 'HR';
          elseif ($user === 'lan') $folders[] = 'Sale';

          if ($user !== 'kh√°ch') {
              $principal = $user . '@nhan.local';
              if (shell_exec("getent group 'GG-Dept-IT'   | grep -Fq '$principal'") === '0') $folders[] = 'IT';
              if (shell_exec("getent group 'GG-Dept-HR'   | grep -Fq '$principal'") === '0') $folders[] = 'HR';
              if (shell_exec("getent group 'GG-Dept-Sale' | grep -Fq '$principal'") === '0') $folders[] = 'Sale';
          }
          $folders = array_unique($folders);

          foreach ($folders as $folder) {
              // ƒê∆∞·ªùng d·∫´n chu·∫©n Windows UNC
              $unc_path = "\\\\$smb_ip\\$folder";
              // Escape d·∫•u \ cho JS
              $js_path = "\\\\\\\\$smb_ip\\\\$folder";
              
              echo "<li class='folder-item'>
                      <span class='folder-name'>üìÅ $folder</span>
                      <button class='btn-copy' onclick=\"copyPath('$js_path')\">Copy Link</button>
                    </li>";
          }
          ?>
              </ul>
              <div style="margin-top: 20px; font-size: 0.85em; color: #666;">
                  *B·∫•m <b>Copy Link</b> r·ªìi d√°n v√†o File Explorer (Win+E) ƒë·ªÉ truy c·∫≠p.
              </div>
          </div>
          <div id="toast" class="toast"></div>
          </body>
          </html>
        dest: /var/www/intranet/index.php
        owner: www-data
        group: www-data
        mode: '0644'

    - name: Deploy VirtualHost chu·∫©n mod_auth_gssapi (intranet.conf)
      template:
        src: templates/intranet.conf.j2
        dest: /etc/apache2/sites-available/intranet.conf
        mode: '0644'
      notify: restart apache2

    - name: Force Enable Apache Modules (rewrite & auth_gssapi)
      shell: a2enmod rewrite auth_gssapi
      register: mod_result
      changed_when: "'Enabling module' in mod_result.stdout"
      notify: restart apache2

    # Task n√†y ch·ªâ b·∫≠t site
    - name: K√≠ch ho·∫°t Intranet Site
      shell: |
        a2dissite 000-default.conf || true
        a2ensite intranet.conf
      args:
        creates: /etc/apache2/sites-enabled/intranet.conf
      notify: restart apache2

  handlers:
    - name: restart apache2
      service:
        name: apache2
        state: restarted
